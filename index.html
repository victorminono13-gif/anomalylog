<script>
// FUNÇÕES DA TELA DE CARREGAMENTO (Mantidas como originais)
function startLoadingScreen() {
  const consoleEl = document.getElementById('console-content');
  const progressBar = document.getElementById('loading-progress');
  const percentageEl = document.getElementById('loading-percentage');
  const statusEl = document.getElementById('loading-status');
  const stageEl = document.getElementById('loading-stage');
  const consoleTimeEl = document.getElementById('console-time');
  
  function updateConsoleTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('pt-BR', {hour12: false});
    const dateStr = now.toLocaleDateString('pt-BR');
    consoleTimeEl.textContent = `${dateStr} ${timeStr}`;
  }
  
  updateConsoleTime();
  setInterval(updateConsoleTime, 1000);
  
  const consoleMessages = [
    {text: "> Inicializando Sistema C.C.O...", delay: 200, type: "prompt"},
    {text: "> Verificando banco de dados global...", delay: 400, type: "system"},
    {text: "[OK] Conexão com repositório estabelecida", delay: 600, type: "success"},
    {text: "> Carregando registros de usuários...", delay: 1000, type: "prompt"},
    {text: "[INFO] Sincronizando anomalias compartilhadas", delay: 1800, type: "warning"},
    {text: "> Terminal pronto.", delay: 2200, type: "prompt"}
  ];
  
  const loadingStages = [
    {stage: "Acessando nuvem...", progress: 30},
    {stage: "Sincronizando arquivos...", progress: 70},
    {stage: "Finalizando...", progress: 100}
  ];
  
  let currentMessage = 0;
  let currentStage = 0;
  
  function addConsoleMessage() {
    if (currentMessage < consoleMessages.length) {
      const msg = consoleMessages[currentMessage];
      const line = document.createElement('div');
      line.className = `console-line ${msg.type}`;
      line.textContent = msg.text;
      consoleEl.appendChild(line);
      consoleEl.scrollTop = consoleEl.scrollHeight;
      currentMessage++;
      setTimeout(addConsoleMessage, msg.delay);
    }
  }
  
  function updateProgress() {
    if (currentStage < loadingStages.length) {
      const stage = loadingStages[currentStage];
      progressBar.style.width = `${stage.progress}%`;
      percentageEl.textContent = `${stage.progress}%`;
      stageEl.textContent = stage.stage;
      statusEl.textContent = stage.stage;
      currentStage++;
      setTimeout(updateProgress, 800);
    } else {
      setTimeout(() => {
        document.getElementById('loading-screen').style.display = 'none';
        document.body.style.opacity = '1';
        initializeMainSystem();
      }, 500);
    }
  }
  
  setTimeout(() => { addConsoleMessage(); updateProgress(); }, 500);
}

// INICIALIZAÇÃO DO SISTEMA PRINCIPAL (CORRIGIDO)
function initializeMainSystem() {
  let saved = JSON.parse(localStorage.getItem('analog_entities') || '[]');
  let importantFiles = JSON.parse(localStorage.getItem('analog_files') || '[]');
  let currentAnomalyIndex = -1;
  const el = id => document.getElementById(id);

  // --- FUNÇÃO PARA OUTROS USUÁRIOS VEREM (SINCRONIZAÇÃO) ---
  // Esta função tenta ler um arquivo chamado database.json no seu GitHub.
  async function syncGlobalData() {
    try {
      const response = await fetch('database.json'); // O arquivo que você subir com as anomalias de todos
      if (response.ok) {
        const globalData = await response.json();
        
        // Mesclar dados globais com os locais
        if (globalData.anomalies || globalData.anomaly) {
          let remoteAnomalies = globalData.anomalies || [globalData.anomaly];
          remoteAnomalies.forEach(remote => {
            if (!saved.some(local => local.id === remote.id)) {
              saved.push(remote);
            }
          });
        }
        
        if (globalData.importantFiles) {
          globalData.importantFiles.forEach(remoteFile => {
            if (!importantFiles.some(localFile => localFile.id === remoteFile.id)) {
              importantFiles.push(remoteFile);
            }
          });
        }
        
        saveAndRefresh();
        console.log("Sincronização global concluída.");
      }
    } catch (e) {
      console.warn("Modo Offline: database.json não encontrado no servidor.");
    }
  }

  function saveAndRefresh() {
    localStorage.setItem('analog_entities', JSON.stringify(saved));
    localStorage.setItem('analog_files', JSON.stringify(importantFiles));
    loadAnomalies(el('searchInput').value);
  }

  // --- CORREÇÃO DO BOTÃO ESCOLHER ARQUIVO (COMPATÍVEL COM KRONOS) ---
  el('jsonInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const jsonData = JSON.parse(ev.target.result);
        
        // Suporte ao formato "Kronos": { anomaly: {}, importantFiles: [] }
        if (jsonData.anomaly) {
          const newAnomaly = jsonData.anomaly;
          const existingIdx = saved.findIndex(a => a.id === newAnomaly.id);
          
          if (existingIdx !== -1) {
            saved[existingIdx] = newAnomaly;
          } else {
            saved.push(newAnomaly);
          }

          // Importar arquivos importantes se existirem no pacote
          if (jsonData.importantFiles && Array.isArray(jsonData.importantFiles)) {
            jsonData.importantFiles.forEach(filePkg => {
              if (!importantFiles.some(f => f.id === filePkg.id)) {
                importantFiles.push(filePkg);
              }
            });
          }
        } 
        // Suporte ao formato direto: { id: "", threat: "" }
        else if (jsonData.id) {
          const existingIdx = saved.findIndex(a => a.id === jsonData.id);
          if (existingIdx !== -1) saved[existingIdx] = jsonData;
          else saved.push(jsonData);
        }

        saveAndRefresh();
        showNotification("Registro C.C.O importado com sucesso.");
        el('jsonInput').value = '';
        
        // Selecionar a anomalia recém importada
        const newIdx = saved.findIndex(a => a.id === (jsonData.anomaly?.id || jsonData.id));
        loadAnomaly(newIdx);

      } catch (error) {
        alert('ERRO: Arquivo corrompido ou formato incompatível.');
        console.error(error);
      }
    };
    reader.readAsText(file);
  });

  function loadAnomalies(searchTerm = '') {
    const anomalyList = el('anomalyList');
    const term = searchTerm.toLowerCase().trim();
    
    let filtered = saved.filter(a => 
      a.id?.toLowerCase().includes(term) || 
      a.threat?.toLowerCase().includes(term)
    );

    el('resultsInfo').textContent = `Total: ${filtered.length} anomalias`;
    anomalyList.innerHTML = '';

    filtered.forEach((anomaly) => {
      const originalIdx = saved.findIndex(a => a.id === anomaly.id);
      const item = document.createElement('div');
      item.className = `anomaly-item ${originalIdx === currentAnomalyIndex ? 'active' : ''}`;
      item.innerHTML = `
        <div class="anomaly-id">${anomaly.id}</div>
        <div class="anomaly-threat">${anomaly.threat || 'NÃO DEFINIDO'}</div>
      `;
      item.onclick = () => loadAnomaly(originalIdx);
      anomalyList.appendChild(item);
    });
  }

  function loadAnomaly(index) {
    if (index < 0 || !saved[index]) return;
    currentAnomalyIndex = index;
    const a = saved[index];
    
    // Efeitos visuais baseados na severidade (Ex: Biológico do Kronos)
    applySeverityEffects(a.severity);

    let dossierHTML = `
      <div class="dossier-section">
        <p><strong>ID:</strong> ${a.id}</p>
        <p><strong>AMEAÇA:</strong> <span class="glitch">${a.threat}</span></p>
        <p><strong>ESTADO:</strong> ${a.severity || 'Estável'}</p>
      </div>
      <div class="dossier-section">
        <h3>RELATO VISUAL</h3>
        <p>${a.visual || 'Sem dados.'}</p>
      </div>
      <div class="dossier-section">
        <h3>COMPORTAMENTO</h3>
        <p>${a.behavior || 'Sem dados.'}</p>
      </div>
      <div class="dossier-section">
        <h3>EFEITOS DOCUMENTADOS</h3>
        <p>${convertBinaryToText(a.effects || '')}</p>
      </div>
      <div class="dossier-section">
        <h3>PROTOCOLOS DE CONTENÇÃO</h3>
        <p>${a.containment || 'Não estabelecidos.'}</p>
      </div>
    `;

    el('dossierContent').innerHTML = dossierHTML;
    
    const pImage = el('pImage');
    if (a.image) {
      pImage.src = a.image;
      pImage.style.display = 'block';
    } else {
      pImage.style.display = 'none';
    }

    loadAnomalies(el('searchInput').value);
    
    // Se a aba de arquivos estiver aberta, atualiza ela
    if (el('filesSection').style.display === 'block') {
      loadFilesForAnomaly(a.id);
    }
  }

  function convertBinaryToText(str) {
    if (!str.match(/[01]/)) return str; // Se não for binário, retorna o texto (Kronos notes)
    try {
      return str.split(' ').map(bin => String.fromCharCode(parseInt(bin, 2))).join('');
    } catch(e) { return str; }
  }

  function applySeverityEffects(sev) {
    document.body.classList.remove('tremor-1', 'tremor-2', 'bio', 'glitch-active');
    if (sev === 'biologico' || sev === 'EXTREMA') {
      document.body.classList.add('bio', 'glitch-active');
    } else if (sev === 'fatal') {
      document.body.classList.add('tremor-2');
    }
  }

  function loadFilesForAnomaly(id) {
    const list = el('filesList');
    const files = importantFiles.filter(f => f.anomalyId === id);
    list.innerHTML = '';
    
    if (files.length === 0) {
      list.innerHTML = '<p class="empty-state">Nenhum arquivo adicional.</p>';
      return;
    }

    files.forEach(f => {
      const item = document.createElement('div');
      item.className = 'file-item';
      item.innerHTML = `<div class="file-label">${f.label}</div><div class="file-info">${new Date(f.date).toLocaleDateString()}</div>`;
      item.onclick = () => alert("NOTAS DO ARQUIVO:\n\n" + f.notes);
      list.appendChild(item);
    });
  }

  // --- BOTÕES DE CONTROLE ---
  el('btnViewFiles').onclick = () => {
    const sec = el('filesSection');
    const isVisible = sec.style.display === 'block';
    sec.style.display = isVisible ? 'none' : 'block';
    el('btnViewFiles').textContent = isVisible ? 'VER ARQUIVOS' : 'OCULTAR ARQUIVOS';
    if (!isVisible && currentAnomalyIndex !== -1) loadFilesForAnomaly(saved[currentAnomalyIndex].id);
  };

  el('btnSearch').onclick = () => loadAnomalies(el('searchInput').value);
  
  el('btnClearAll').onclick = () => {
    if(confirm("Deseja apagar sua visualização local?")) {
      localStorage.clear();
      location.reload();
    }
  };

  function showNotification(msg) {
    const n = document.createElement('div');
    n.style.cssText = "position:fixed;bottom:20px;right:20px;background:#00aaff;color:#fff;padding:10px 20px;font-size:0.8em;border-radius:4px;z-index:10000;font-family:monospace";
    n.textContent = msg;
    document.body.appendChild(n);
    setTimeout(() => n.remove(), 3000);
  }

  // Iniciar sincronização
  syncGlobalData();
  loadAnomalies();
}

// INICIAR TELA
window.onload = startLoadingScreen;
</script>
